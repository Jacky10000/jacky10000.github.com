<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<body>
	</body>
	<script type="text/javascript">
//		var a = {name:'yy'};
//		var b = {age:'bb'};
//		Object.defineProperty(a,'name',b)
//		console.log(Object.defineProperty(a,'age',{
//			value:'11'
//		}))
//		Object.defineProperty()
		
	</script>
	<!--<script type="text/javascript">
		var Book = {}
		var name = '';
		Object.defineProperty(Book, 'name', {
		  set: function (value) {
		    name = value;
		    console.log('你取了一个书名叫做' + value);
		  },
		  get: function () {
		    return '《' + name + '》'
		  }
		})
		 
		Book.name = 'vue权威指南';  // 你取了一个书名叫做vue权威指南
		console.log(Book.name);
	</script>-->
	<script type="text/javascript">
		function defineReactive(data, key, val) {
		    observe(val); // 递归遍历所有子属性
		    var dep = new Dep(); 
		    Object.defineProperty(data, key, {
		        enumerable: true,
		        configurable: true,
		        get: function() {
		        	if (Dep.target) {
		                dep.addSub(Dep.target); // 在这里添加一个订阅者
		            }
		            return val;
		        },
		        set: function(newVal) {
		        	if (val === newVal) {
		                return;
		            }
		            val = newVal;
		            console.log('属性' + key + '已经被监听了，现在值为：“' + newVal.toString() + '”');
		            dep.notify();
		        }
		    });
		}
		Dep.target = null; 
		function observe(data) {
		    if (!data || typeof data !== 'object') {
		        return;
		    }
		    Object.keys(data).forEach(function(key) {
		        defineReactive(data, key, data[key]);
		    });
		};
		
		function Dep () {
		    this.subs = [];
		}
		Dep.prototype = {
		    addSub: function(sub) {
		        this.subs.push(sub);
		    },
		    notify: function() {
		        this.subs.forEach(function(sub) {
		            sub.update();
		        });
		    }
		};
		
//		Watcher函數
		
		function Watcher(vm, exp, cb) {
		    this.cb = cb;
		    this.vm = vm;
		    this.exp = exp;
		    this.value = this.get();  // 将自己添加到订阅器的操作
		}
		 
		Watcher.prototype = {
		    update: function() {
		        this.run();
		    },
		    run: function() {
		        var value = this.vm.data[this.exp];
		        var oldVal = this.value;
		        if (value !== oldVal) {
		            this.value = value;
		            this.cb.call(this.vm, value, oldVal);
		        }
		    },
		    get: function() {
		        Dep.target = this;  // 缓存自己
		        var value = this.vm.data[this.exp]  // 强制执行监听器里的get函数
		        Dep.target = null;  // 释放自己
		        return value;
		    }
		};
		
		 
		var library = {
		    book1: {
		        name: ''
		    },
		    book2: ''
		};
		observe(library);
		library.book1.name = 'vue权威指南'; // 属性name已经被监听了，现在值为：“vue权威指南”
		library.book2 = '没有此书籍';  // 属性book2已经被监听了，现在值为：“没有此书籍”
	</script>

</html>
